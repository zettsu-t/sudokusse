# Makefile
LD=g++
CXX=g++
AS=as
RUBY=ruby

INCLUDES=-I. -I.. -Iunittest

# Set -DSOLVE_PARALLEL to solve puzzles parallel
CPPFLAGS_PARALLEL+=-DSOLVE_PARALLEL

LIBPATH=
LIBCFLAGS=
LIBS_COMMON=-lcppunit

ifneq ($(OS),Windows_NT)
# Workaround for GCC 4.8 and std::thread
GCC_MAJOR_VERSION:=$(shell export LC_ALL=C ; gcc -v 2>&1 | tail -1 | cut -d " " -f 3 | cut -d "." -f1)
LDFLAGS=-Wl,--no-as-needed $(LIBCFLAGS)
LIBS=-lpthread $(LIBS_COMMON)
else
# MinGW with CppUnit not supported
LDFLAGS=$(LIBCFLAGS)
LIBS=$(LIBS_COMMON)
endif

CPPFLAGS_COMMON=-std=c++11 -O0 -g -Wall -masm=intel -m64 -DUNITTEST $(INCLUDES) $(LIBCFLAGS) $(CPPFLAGS_PARALLEL)
CPPFLAGS_SSE=$(CPPFLAGS_COMMON) -msse4.2 -DSUDOKU_USE_AVX=0
CPPFLAGS_AVX=$(CPPFLAGS_COMMON) -mavx2 -DSUDOKU_USE_AVX=1

ASFLAGS_UNPACKED=-defsym CellsPacked=0
ASFLAGS_PACKED=-defsym CellsPacked=1
ASFLAGS_SSE=-defsym EnableAvx=0
ASFLAGS_AVX=-defsym EnableAvx=1

POSTFIX_UNPACKED=_unpacked
POSTFIX_PACKED=_packed
POSTFIX_SSE=_sse
POSTFIX_AVX=_avx

CELLS_UNPACKED_TARGET_SSE=unittest_cells$(POSTFIX_UNPACKED)$(POSTFIX_SSE)
CELLS_PACKED_TARGET_SSE=unittest_cells$(POSTFIX_PACKED)$(POSTFIX_SSE)
CELLS_UNPACKED_TARGET_AVX=unittest_cells$(POSTFIX_UNPACKED)$(POSTFIX_AVX)
CELLS_PACKED_TARGET_AVX=unittest_cells$(POSTFIX_PACKED)$(POSTFIX_AVX)

TARGETS=$(CELLS_UNPACKED_TARGET_SSE) $(CELLS_PACKED_TARGET_SSE) \
        $(CELLS_UNPACKED_TARGET_AVX) $(CELLS_PACKED_TARGET_AVX)

ifneq (,$(findstring linux,$(shell gcc -dumpmachine)))
TESTED_OS_DEPENDENT_OBJ=sudoku_linux.o
TESTER_OS_DEPENDENT_OBJ=sudokulinuxtest.o
else
TESTED_OS_DEPENDENT_OBJ=sudoku_windows.o
TESTER_OS_DEPENDENT_OBJ=sudokuwindowstest.o
endif
OS_DEPENDENT_OBJS=$(TESTED_OS_DEPENDENT_OBJ) $(TESTER_OS_DEPENDENT_OBJ)

TESTER_OBJS=main.o sudokussetest.o sudokutest.o sudokucelltest.o \
            sudokumaptest.o sudokusolvertest.o sudokuloadertest.o
TESTED_OBJS=sudoku.o sudokuxmmreg.o
CPP_OBJS=$(TESTER_OBJS) $(TESTED_OBJS)

ASM_UNPACKED_OBJS=sudokusse_cells$(POSTFIX_UNPACKED).o
ASM_PACKED_OBJS=sudokusse_cells$(POSTFIX_PACKED).o

CELLS_UNPACKED_OBJS_SSE=$(patsubst %.o,%$(POSTFIX_SSE).o,$(CPP_OBJS) $(ASM_UNPACKED_OBJS) $(OS_DEPENDENT_OBJS))
CELLS_PACKED_OBJS_SSE=$(patsubst %.o,%$(POSTFIX_SSE).o,$(CPP_OBJS) $(ASM_PACKED_OBJS) $(OS_DEPENDENT_OBJS))
CELLS_UNPACKED_OBJS_AVX=$(patsubst %.o,%$(POSTFIX_AVX).o,$(CPP_OBJS) $(ASM_UNPACKED_OBJS) $(OS_DEPENDENT_OBJS))
CELLS_PACKED_OBJS_AVX=$(patsubst %.o,%$(POSTFIX_AVX).o,$(CPP_OBJS) $(ASM_PACKED_OBJS) $(OS_DEPENDENT_OBJS))
OBJS=$(sort $(CELLS_UNPACKED_OBJS_SSE) $(CELLS_PACKED_OBJS_SSE) $(CELLS_UNPACKED_OBJS_AVX) $(CELLS_PACKED_OBJS_AVX))

HEADERS=../sudoku.h ../sudoku_os_dependent.h sudokutest.h sudokutest_os_dependent.h
GENERATED_CODES=sudokuConstAll.h
GENERATOR_SCRIPT=../sudokumap.rb

VPATH=. ..

ALL_UPDATED_VARIABLES= \
	LD CXX AS RUBY \
	INCLUDES CPPFLAGS_PARALLEL LIBPATH LIBCFLAGS LIBS_COMMON GCC_MAJOR_VERSION LDFLAGS LIBS \
	CPPFLAGS_COMMON CPPFLAGS_SSE CPPFLAGS_AVX \
	ASFLAGS_UNPACKED ASFLAGS_PACKED ASFLAGS_SSE ASFLAGS_AVX \
	POSTFIX_UNPACKED POSTFIX_PACKED POSTFIX_SSE POSTFIX_AVX \
	CELLS_UNPACKED_TARGET_SSE CELLS_PACKED_TARGET_SSE CELLS_UNPACKED_TARGET_AVX CELLS_PACKED_TARGET_AVX \
	TARGETS TESTED_OS_DEPENDENT_OBJ TESTER_OS_DEPENDENT_OBJ OS_DEPENDENT_OBJS \
	TESTER_OBJS TESTED_OBJS CPP_OBJS \
	ASM_UNPACKED_OBJS ASM_PACKED_OBJS \
	CELLS_UNPACKED_OBJS_SSE CELLS_PACKED_OBJS_SSE CELLS_UNPACKED_OBJS_AVX CELLS_PACKED_OBJS_AVX OBJS \
	HEADERS GENERATED_CODES GENERATOR_SCRIPT VPATH

#Local Variables:
#mode: Makefile
#coding: utf-8-dos
#End:
