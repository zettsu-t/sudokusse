# Makefile
LD=g++
CXX=g++
AS=as
RUBY=ruby

# Set 0 to use SSE and 1 to AVX
USE_AVX_VALUE=1
ASFLAGS_SSE_AVX=-defsym EnableAvx=$(USE_AVX_VALUE)

ifeq ($(USE_AVX_VALUE),0)
CPPFLAGS_SSE_AVX=-msse4.2
else
CPPFLAGS_SSE_AVX=-mavx2
endif

CPPFLAGS_INTEL_SYNTAX=-masm=intel

ifneq ($(OS),Windows_NT)
# Workaround for GCC 4.8 and std::thread
GCC_MAJOR_VERSION:=$(shell export LC_ALL=C ; gcc -v 2>&1 | tail -1 | cut -d " " -f 3 | cut -d "." -f1)
ifeq ($(GCC_MAJOR_VERSION),4)
LDFLAGS=-Wl,--no-as-needed
LIBS=-lpthread
else
LDFLAGS=
LIBS=
endif
CPPFLAGS_PARALLEL=

else
ifneq (,$(findstring cygwin,$(shell gcc -dumpmachine)))
ifeq (yes,$(USE_BOOST_THREAD))
LDFLAGS=
LIBS=-lboost_system -lboost_thread
CPPFLAGS_PARALLEL=-DSOLVE_PARALLEL_WITH_BOOST_THREAD
else
LDFLAGS=
LIBS=
CPPFLAGS_PARALLEL=
endif

else
# MinGW does not support C++11 thread
ifeq (yes,$(USE_BOOST_THREAD))
LDFLAGS=-LC:\MinGW\lib
LIBS=-lboost_system -lboost_thread
CPPFLAGS_PARALLEL=-IC:\MinGW\include -DSOLVE_PARALLEL_WITH_BOOST_THREAD
else
LDFLAGS=
LIBS=
CPPFLAGS_PARALLEL=-DNO_PARALLEL
endif

endif
endif

# -O2 optimization is better than -O3 in this program
# Do not set -masm=intel for sources which include boost::thread
# -Wconversion causes warnings that are ignorable.
CPPFLAGS_WALL=-Wall -W -Wformat=2 -Wcast-qual -Wcast-align -Wwrite-strings -Wfloat-equal -Wpointer-arith -Wno-unused-parameter
CPPFLAGS=-std=c++11 -O2 $(CPPFLAGS_WALL) -m64 $(CPPFLAGS_SSE_AVX) $(CPPFLAGS_PARALLEL)

CELLS_UNPACKED_TARGET=bin/sudokusse
CELLS_PACKED_TARGET=bin/sudokusse_cells_packed
TARGETS=$(CELLS_UNPACKED_TARGET) $(CELLS_PACKED_TARGET)

ifneq (,$(findstring linux,$(shell gcc -dumpmachine)))
OS_DEPENDENT_OBJ=sudoku_linux.o
else
OS_DEPENDENT_OBJ=sudoku_windows.o
endif

CELLS_COMMON_OBJS=sudokumain.o sudoku.o sudokuxmmreg.o sudoku_std.o sudoku_boost.o
CELLS_UNPACKED_OBJS=$(CELLS_COMMON_OBJS) sudokusse_cells_unpacked.o $(OS_DEPENDENT_OBJ)
CELLS_PACKED_OBJS=$(CELLS_COMMON_OBJS) sudokusse_cells_packed.o $(OS_DEPENDENT_OBJ)
OBJS=$(sort $(CELLS_UNPACKED_OBJS) $(CELLS_PACKED_OBJS))

HEADERS=sudoku.h sudoku_os_dependent.h
GENERATED_CODE=sudokuConstAll.h
GENERATOR_SCRIPT=sudokumap.rb

ALL_UPDATED_VARIABLES= \
	LD CXX AS RUBY \
	USE_AVX_VALUE ASFLAGS_SSE_AVX CPPFLAGS_SSE_AVX CPPFLAGS_INTEL_SYNTAX \
	USE_BOOST_THREAD GCC_MAJOR_VERSION LDFLAGS LIBS CPPFLAGS_PARALLEL CPPFLAGS \
	CELLS_UNPACKED_TARGET CELLS_PACKED_TARGET TARGETS \
	OS_DEPENDENT_OBJ CELLS_COMMON_OBJS CELLS_UNPACKED_OBJS CELLS_PACKED_OBJS OBJS \
	HEADERS GENERATED_CODE GENERATOR_SCRIPT \

#Local Variables:
#mode: Makefile
#coding: utf-8-dos
#End:
